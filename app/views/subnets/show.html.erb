<% content_for :title, @subnet.name %>

<% content_for :page_header do %>
  <%= @subnet.name %>
<% end %>

<% content_for :header_action_buttons do %>
  <%= link_to "Edit", edit_subnet_path(@subnet), class: "btn bg-orange-400 text-white font-semibold rounded-md pi-4 pb-2 show@md", data: { turbo_frame: "modal" } %>

  <% delete_trigger = button_tag "Delete", type: "button", class: "btn bg-white border border-red-200 text-red-600 font-semibold hover:bg-red-50", data: { action: "dialog#showModal", menu_target: "item" }, role: "menuitem" %>
  <%= modal_dialog delete_trigger, size: "450px", title: "Delete '#{@subnet.name}'?" do %>
    <p class="text-sm text-subtle mbe-4">This will permanently delete this subnet. This action cannot be undone.</p>
    <div class="flex items-center justify-end gap">
      <button type="button" class="btn" data-action="click->dialog#close">Cancel</button>
      <%= button_to "Continue", @subnet, method: :delete, data: { turbo: false }, class: "btn btn--negative" %>
    </div>
  <% end %>
<% end %>

<div class="absolute hide@md" style="bottom: 10rem; right: 1rem; z-index: 9999">
  <%= link_to edit_subnet_path(@subnet), class: "btn bg-orange-400 text-white font-semibold rounded-full p-5", data: { turbo_frame: "modal" } do %>
    <span class="icon icon--square-pen"></span>
  <% end %>
</div>

<div class="p-4 i-full">
  <div class="flex items-center justify-between mbe-6">
    <div class="flex items-center gap-4">
      <%= link_to subnets_path, class: "btn btn--subtle btn--icon" do %>
        <span class="icon icon--chevron-left"></span>
      <% end %>
      <div>
        <h1 class="text-3xl font-bold"><%= @subnet.name %></h1>
        <div class="font-mono text-link"><%= @subnet.network_address %></div>
      </div>
    </div>
  </div>

  <%# --- Stats Bar --- %>
  <% 
    total = @subnet.ip_addresses.count 
    used = @subnet.ip_addresses.where.not(device_id: nil).count
    percent = total > 0 ? ((used.to_f / total) * 100).round : 0
  %>
  <div class="card p-4 border rounded-md bg-white shadow-sm mbe-6">
    <div class="flex justify-between items-end mbe-2">
      <span class="font-bold text-sm uppercase text-subtle">Utilization</span>
      <span class="font-semibold text-lg"><%= used %> / <%= total %> IPs Used (<%= percent %>%)</span>
    </div>

    <%# --- CORRECTED PROGRESS COMPONENT --- %>
    <label class="block i-full">
      <%= tag.progress value: used, max: total, class: "progress", role: "progressbar" %>
      <span class="sr-only">Utilization <%= percent %>%</span>
    </label>
  </div>

  <%# --- IP Grid --- %>
  <div class="card p-4 border rounded-md bg-white shadow-sm">
    <h3 class="font-bold text-lg mbe-4">IP Address Pool</h3>
    <div class="grid grid-cols-2 grid-cols-4@md grid-cols-6@lg gap-3">
      <% @subnet.ip_addresses.order(:address).each do |ip| %>
        <% 
          bg_class = if ip.active?
                       'bg-red-50 border-red-200 text-red-800'
                     elsif ip.reserved?
                        'bg-yellow-50 border-yellow-200 text-yellow-800'
                     else
                       'bg-green-50 border-green-200 text-green-800'
                     end
        %>
        <%= link_to edit_ip_address_path(ip), class: "p-2 rounded-md border text-center transition hover:shadow-md #{bg_class}", data: { turbo_frame: "modal" } do %>
          <div class="font-mono font-bold text-sm"><%= ip.address.to_s.split('.').last %></div>
          <div class="text-xs opacity-75 truncate">
            <% if ip.device %>
              <%= ip.device.name %>
            <% else %>
              <%= ip.status %>
            <% end %>
          </div>
        <% end %>
      <% end %>
    </div>
  </div>
</div>