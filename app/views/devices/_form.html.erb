<!-- NOTE: This form requires logic to fetch free IPs. 
    Ideally, a Stimulus controller would listen to 'subnet_id' change and fetch IPs.
    For this output, I will render the subnets and allow selecting an IP. -->

<%= form_with(model: device, html: { contents: true }) do |form| %>
  <%= render "shared/error_messages", object: device %>

  <h4 class="font-bold border p-4 rounded-lg mbe-4">Hardware Details</h4>
  <div class="grid grid-cols-1 grid-cols-2@md gap-4 mbe-6">
    <div class="col-span-1">
      <%= form.label :name, "Hostname", class: "block font-medium mbe-1" %>
      <%= form.text_field :name, class: "input w-full p-2 border rounded" %>
    </div>
    <div class="col-span-1">
      <%= form.label :serial_number, class: "block font-medium mbe-1" %>
      <%= form.text_field :serial_number, class: "input w-full p-2 border rounded" %>
    </div>
    <div class="col-span-1">
      <%= form.label :asset_tag, class: "block font-medium mbe-1" %>
      <%= form.text_field :asset_tag, class: "input w-full p-2 border rounded" %>
    </div>
    <div class="col-span-1">
      <%= form.label :device_type, class: "block font-medium mbe-1" %>
      <%= form.select :device_type, Device.device_types.keys.map { |k| [k.humanize, k] }, {}, { class: "input w-full p-2 border rounded" } %>
    </div>
  </div>

  <h4 class="font-bold border rounded-lg p-4 pb-3 mbe-4">Assignment & Network</h4>
  <div class="grid grid-cols-1 grid-cols-2@md gap-4 mbe-6">
    <div class="col-span-1">
      <%= form.label :department_id, class: "block font-medium mbe-1" %>
      <%= form.collection_select :department_id, Department.all, :id, :name, { prompt: "Select Dept" }, { class: "input w-full p-2 border rounded" } %>
    </div>
    <div class="col-span-1">
      <%= form.label :employee_id, "Assign Owner (Optional)", class: "block font-medium mbe-1" %>
      <%= form.collection_select :employee_id, Employee.where(status: :active), :id, :full_name, { include_blank: "Unassigned" }, { class: "input w-full p-2 border rounded" } %>
    </div>
  </div>
    
  <%# --- IP Assignment Block --- %>
  <div class="col-span-full card">
    <label class="block font-bold mbe-2">IP Address Assignment</label>
    
    <%# This would ideally be a Turbo Frame that updates when a Subnet is picked %>
    <div class="grid grid-cols-2 gap-4">
      <div>
        <label class="text-xs text-subtle">Filter by Subnet</label>
        <%= select_tag "subnet_filter", options_from_collection_for_select(Subnet.all, :id, :name), 
            prompt: "Select Network...", class: "input w-full p-2 border rounded",
            data: { controller: "subnet-select" } %>
      </div>
      
      <div>
        <label class="text-xs text-subtle">Available IP</label>
        <%# Note: The controller expects params[:device][:ip_address_id] %>
        <%# We preload ALL free IPs grouped by subnet or similar, but for simplicity here we show a flat list of all free IPs %>
        <%= form.collection_select :ip_address_id, IpAddress.free.limit(100), :id, :address, { include_blank: "Do not assign IP" }, { class: "input w-full p-2 border rounded" } %>
      </div>
    </div>
  </div>

  <div class="flex gap-3 mbs-4 items-center">
    <%= form.submit "Save Device", class: "btn bg-orange-400 text-white font-semibold rounded px-4 py-2" %>
    <%= link_to "Cancel", devices_path, class: "text-subtle" %>
  </div>
<% end %>